## 4ï¸âƒ£ GraphQL codegen ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 4.1 GraphQL ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›æ©Ÿèƒ½ã‚’è¿½åŠ 

GraphQLã‚¹ã‚­ãƒ¼ãƒå‡ºåŠ›å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts: tools/graphql-codegen/export-schema.ts
import fs from 'node:fs';
import path from 'node:path';
import { lexicographicSortSchema, printSchema } from 'graphql';
import { schema } from '~/.server/lib/graphql/schema';

const main = async () => {
  const outputFile = './tools/graphql-codegen/schema.graphql';

  const schemaAsString = printSchema(lexicographicSortSchema(schema));
  await fs.writeFileSync(outputFile, schemaAsString);
  console.log(`ğŸŒ™${path.resolve(outputFile)} is created!`);
};

main();
```

package.json ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json: package.json
  "scripts": {
    // ...
    "--- GRAPHQL SECTION ---": "--- --- --- --- ---",
    "graphql:schema": "npx tsx ./tools/graphql-codegen/export-schema.ts",
    // ...
  }
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`schema.graphql`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
graphql-codegenã§ã¯ã€ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’èª­ã¿è¾¼ã‚“ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### 4.2 graphql-codegenã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm i graphql
npm i -D typescript @graphql-codegen/cli @graphql-codegen/client-preset
npm i -D @parcel/watcher
```

`@parcel/watcher`ã¯watchãƒ¢ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹éš›ã«å¿…è¦ã¨ãªã‚‹ã€‚

### 4.3 codegen configãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```ts: tools/graphql-codegen/codegen.ts
import type { CodegenConfig } from '@graphql-codegen/cli';

const config: CodegenConfig = {
  schema: 'tools/graphql-codegen/schema.graphql',
  overwrite: true,
  documents: ['app/**/*.tsx', 'app/**/*.ts'],
  ignoreNoDocuments: true, // for better experience with the watcher
  hooks: { afterAllFileWrite: ['biome check --write'] },
  generates: {
    './app/.server/lib/graphql/@generated/': {
      preset: 'client',
      plugins: [],
      config: {
        scalars: { DateTime: 'string' },
      },
    },
  },
};

export default config;
```

è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾åˆ©ç”¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€`hooks: { afterAllFileWrite: ['biome check --write'] }`ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

### 4.4 package.jsonã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 

```json: package.json
  "scripts": {
    // ...
    "graphql:codegen": "graphql-codegen -c tools/graphql-codegen/codegen.ts",
    "graphql:codegen-watch": "graphql-codegen -c tools/graphql-codegen/codegen.ts --watch",
    // ...
  }
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€GraphQLã®å‹ç”Ÿæˆã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/d9784a29eec2-20250305.png)

:::details è£œè¶³. è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®Lintã‚¨ãƒ©ãƒ¼ç„¡è¦–

è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ã€Lintã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚
ã“ã“ã§ã¯ã€Biomeã®å ´åˆã®è¨­å®šã‚’å‚è€ƒã«è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚

```diff biome.json
{
  "$schema": "./node_modules/@biomejs/biome/configuration_schema.json",
  "vcs": {
    "enabled": true,
    "clientKind": "git",
    "useIgnoreFile": true
  },
  "files": {
    "include": ["**/*.ts", "**/*.tsx", "**/*.js"],
    "ignore": ["**/.react-router", "**/.vscode", "**/node_modules"]
  },
  "formatter": {
    "indentStyle": "space",
    "ignore": []
  },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true,
      "nursery": {
        "useSortedClasses": "warn"
      },
      "correctness": {
        "noUnusedImports": "warn",
        "noUnusedVariables": "warn"
      }
    }
  },
  "organizeImports": {
    "enabled": true
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "single",
      "semicolons": "always"
    }
  },
  "overrides": [
    {
      "include": ["app/components/shadcn/ui/**"],
      "linter": {
        "rules": {
          "nursery": {
            "useSortedClasses": "off"
          }
        }
      }
    },
+   {
+     "include": ["app/.server/lib/graphql/@generated/**"],
+     "linter": {
+       "rules": {
+         "suspicious": {
+           "noExplicitAny": "off"
+         }
+       }
+     }
+   }
  ]
}
```

è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯`any`ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã®ã§ã€è­¦å‘Šã‚’ç„¡è¦–ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

:::

## 5ï¸âƒ£ graphql-request ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 5.1 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
npm i graphql-request
```

### 5.2 GraphQL API URLã‚’ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ 

```sh: .env
# API GraphQL URL
API_GQL_URL='http://localhost:5173/api/graphql'
```

```ts: app/config/env.ts
export const env = {
  // ...
+ API_GQL_URL: process.env.API_GQL_URL as string,
};
```

### 5.3 GraphQL Clientã‚’ä½œæˆ

```ts: app/lib/graphql-client/index.ts
import { ClientError, GraphQLClient } from 'graphql-request';
import { env } from '~/config/env';

/**
 * ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¦GraphQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
 *
 * @param {Request | undefined} [request] - ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 * @returns {Promise<GraphQLClient>} åˆæœŸåŒ–ã•ã‚ŒãŸGraphQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è§£æ±ºã™ã‚‹Promiseã€‚
 * @example
 * ```typescript
 * const client = await initializeClient(request);
 * ```
 */
export const initializeClient = async (
  request: Request | undefined = undefined,
) => {
  const headers: Record<string, string> = {};

  if (request) {
    try {
      // ç‰¹å®šã®é‡è¦ãªãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ã‚’é¸æŠçš„ã«è¿½åŠ 
      const selectHeaders = [
        // NOTE: cookieã¯GraphQLã‚µãƒ¼ãƒãƒ¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã«å¿…è¦
        'cookie',
      ];

      for (const headerName of selectHeaders) {
        const headerValue = request.headers.get(headerName);
        if (headerValue) {
          headers[headerName] = headerValue;
        }
      }
    } catch (error) {
      console.error('An error occurred while retrieving headers:', error);
    }
  }

  // GraphQLClientã®åˆæœŸåŒ–
  const client = new GraphQLClient(env.API_GQL_URL, {
    fetch: fetch,
    headers: {
      // NOTE: Content-Typeã‚’æŒ‡å®šã—ãªã„ã¨GqphQLã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã€‚
      'Content-Type': 'application/json',
      ...headers,
    },
  });

  return client;
};

/**
 * `ClientError`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰å…ƒã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
 *
 * @param error - å…ƒã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡ºã™ã‚‹`ClientError`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
 * @returns å…ƒã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’è¿”ã—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯`null`ã‚’è¿”ã—ã¾ã™ã€‚
 */
export const getOriginalErrorMessage = (error: ClientError): string | null => {
  if (error instanceof ClientError) {
    const originalError = error.response?.errors?.[0]?.extensions
      ?.originalError as { message: string } | undefined;

    if (originalError?.message) {
      return originalError.message;
    }
  }
  return null;
};

```

## 6ï¸âƒ£ å‹•ä½œç¢ºèª

### 6.1 ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®GraphQLã‚’ä½œæˆ

```tsx: app/routes/__.demo.graphql._index/route.tsx
const getPlanets = graphql(`
query getPlanets {
  planets {
    edges {
      node {
        id
        name
      }
    }
    totalCount
  }
}
`);
```

### 6.2 graphql-codegenã‚’å®Ÿè¡Œ

```sh
npm run graphql:codegen
```

### 6.3 ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

```tsx: app/routes/__.demo.graphql._index/route.tsx
import { graphql } from '~/.server/lib/graphql/@generated';
import {
  Table,
  TableBody,
  TableCaption,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '~/components/shadcn/ui/table';
import {
  getOriginalErrorMessage,
  initializeClient,
} from '~/lib/graphql-client';
import type { Route } from './+types/route';

const getPlanets = graphql(`
query getPlanets {
  planets {
    edges {
      node {
        id
        name
      }
    }
    totalCount
  }
}
`);

export const loader = async ({ request }: Route.LoaderArgs) => {
  const client = await initializeClient(request);
  return await client
    .request(getPlanets)
    .then((planets) => planets)
    .catch((error) => {
      const errorMessage = getOriginalErrorMessage(error);
      return { errorMessage: errorMessage ?? (error.message as string) };
    });
};

const DemoGraphqlPage = ({ loaderData }: Route.ComponentProps) => {
  if ('errorMessage' in loaderData) {
    return <div>{loaderData.errorMessage}</div>;
  }

  const planets = loaderData.planets?.edges;

  return (
    <>
      <Table>
        <TableCaption>A list of planets</TableCaption>
        <TableHeader>
          <TableRow>
            <TableHead>ID</TableHead>
            <TableHead>Name</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {planets?.map((planet) => (
            <TableRow key={planet?.node?.id}>
              <TableCell>{planet?.node?.id}</TableCell>
              <TableCell>{planet?.node?.name}</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </>
  );
};

export default DemoGraphqlPage;
```

å®Œæˆç”»é¢
![image](https://storage.googleapis.com/zenn-user-upload/4250017e8dd2-20250306.png)

## è£œè¶³

### DBãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°æ™‚ã®æ”¹ä¿®æ‰‹é †ã®æµã‚Œ

1. `schema.prisma`ã‚’æ›´æ–°
2. prisma migrate ã‚’å®Ÿè¡Œ
3. prisma generate ã‚’å®Ÿè¡Œ
4. GraphQL Pothosã®ã‚¹ã‚­ãƒ¼ãƒã‚’è¿½åŠ 
   - ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
   - DTOã‚’è¿½åŠ 
   - ãƒªã‚¾ãƒ«ãƒï¼ˆQuery, Mutationï¼‰ã‚’è¿½åŠ 
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆTypeã€Resolverå®šç¾©å‡¦ç†å®Ÿè¡Œï¼‰ã‚’è¿½åŠ 
   - `schema.ts`ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’è¿½åŠ 
5. `npm run graphql:schema`ã§ã€ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
6. tsãƒ•ã‚¡ã‚¤ãƒ«ã«ã€GraphQLã‚’è¨˜è¼‰
7. `graphql:codegen`ã§ã€å‹ç”Ÿæˆã‚’è‡ªå‹•ç”Ÿæˆ

### GraphQLãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ 

ä»Šå›ã®GraphQLãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã¯ã€NestJSã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

#### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã®ãƒã‚¤ãƒ³ãƒˆ

âœ… **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã”ã¨ã«åˆ†é›¢** â†’ æ‹¡å¼µæ€§ãŒé«˜ãã€æ–°è¦è¿½åŠ ãŒå®¹æ˜“  
âœ… **DTO, ãƒ¢ãƒ‡ãƒ«, ãƒªã‚¾ãƒ«ãƒã‚’æ•´ç†** â†’ è¦æ¨¡ãŒå¤§ãããªã£ã¦ã‚‚ãƒ¡ãƒ³ãƒ†ã—ã‚„ã™ã„  
âœ… **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’çµ±ä¸€** â†’ å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’æ˜ç¢ºã«ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ•´ç†ã—ã‚„ã™ãã™ã‚‹

#### ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ 

```text
app/
  â”œâ”€â”€ .server/
  â”‚   â”œâ”€â”€ lib/
  â”‚   â”‚   â”œâ”€â”€ graphql/
  â”‚   â”‚   â”‚   â”œâ”€â”€ builder.ts
  â”‚   â”‚   â”‚   â”œâ”€â”€ context.ts
  â”‚   â”‚   â”‚   â”œâ”€â”€ modules/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ post/
  â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
  â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ args/
  â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ get-post-args.dto.ts
  â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ input/
  â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create-post-input.dto.ts
  â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ update-post-input.dto.ts
  â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ delete-post-input.dto.ts
  â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ post.type.ts
  â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ post.resolver.ts
  â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ post.module.ts
  â”‚   â”‚   â”‚   â”œâ”€â”€ schema.ts
```
