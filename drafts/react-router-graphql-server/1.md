# React Router v7 | GraphQLã‚µãƒ¼ãƒãƒ¼å®Ÿè£…æ–¹æ³•

React Router v7ã«ã€GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

ğŸ‘‡ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰
[@card](https://github.com/atman-33/react-router-v7-boilerplate/tree/keep/graphql)

## 1ï¸âƒ£ æ¦‚è¦

### åˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é–¢ä¿‚æ€§ã¨å½¹å‰²

| ãƒ„ãƒ¼ãƒ«               | å½¹å‰²ãƒ»ç‰¹å¾´ | ã©ã“ã§ä½¿ã†ã‹ |
|---------------------|----------|------------|
| **GraphQL Yoga**   | GraphQL ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã€‚Fastify, Express ãªã©ã¨çµ±åˆå¯èƒ½ | **ã‚µãƒ¼ãƒãƒ¼** |
| **Pothos GraphQL** | TypeScript ã§å‹å®‰å…¨ãª GraphQL ã‚¹ã‚­ãƒ¼ãƒã‚’æ§‹ç¯‰ã§ãã‚‹ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ãƒ¼ | **ã‚µãƒ¼ãƒãƒ¼** |
| **GraphQL Codegen** | GraphQL ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å‹å®šç¾©ã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ | **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ & ã‚µãƒ¼ãƒãƒ¼** |
| **graphql-request** | è»½é‡ãª GraphQL ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ã«ç‰¹åŒ– | **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ** |

![image](https://storage.googleapis.com/zenn-user-upload/7a6ecbdde33c-20250307.png)

### **é–¢ä¿‚æ€§**

1. **GraphQL YOGA**  
   â†’ GraphQL ã‚µãƒ¼ãƒãƒ¼ã‚’æä¾›ã™ã‚‹ã€‚  
   â†’ **Pothos GraphQL** ã‚’åˆ©ç”¨ã—ã¦å‹å®‰å…¨ãªã‚¹ã‚­ãƒ¼ãƒã‚’æ§‹ç¯‰ã§ãã‚‹ã€‚  

2. **Pothos GraphQL**  
   â†’ TypeScript ã§ã‚¹ã‚­ãƒ¼ãƒã‚’æ§‹ç¯‰ã—ã€GraphQL YOGA ã§æä¾›ã™ã‚‹ã€‚  
   â†’ `t.relation()` ãªã©ã‚’ä½¿ã„ã€Prisma ã¨ã®çµ±åˆã‚‚å¯èƒ½ã€‚  

3. **GraphQL Codegen**  
   â†’ GraphQL ã‚¹ã‚­ãƒ¼ãƒï¼ˆPothos ã‚„ Yoga ã§å®šç¾©ã•ã‚ŒãŸã‚‚ã®ï¼‰ã‚’å…ƒã«å‹ã‚„ã‚¯ã‚¨ãƒªé–¢æ•°ã‚’è‡ªå‹•ç”Ÿæˆã€‚  
   â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ `graphql-request` ã‚„ `urql` ãªã©ã¨é€£æºã§ãã‚‹ã€‚  

4. **graphql-request**  
   â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ GraphQL API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚  
   â†’ **GraphQL Codegen** ã‚’ä½¿ã†ã¨ã€å‹å®‰å…¨ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆå¯èƒ½ã€‚  

## 2ï¸âƒ£ GraphQL Yogaã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 2.1 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm i graphql graphql-yoga
```

### 2.2 GraphQLã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€GraphQLã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```ts: app/routes/api.graphql/route.ts
import { createSchema, createYoga } from 'graphql-yoga';
import type { Route } from './+types/route';

// Define your schema and resolvers
const typeDefs = /* GraphQL */ `
  type Query {
    hello: String
  }
`;

const resolvers = {
  Query: {
    hello: () => 'Hello from Yoga!',
  },
};

const schema = createSchema({
  typeDefs,
  resolvers,
});

const yoga = createYoga({
  schema,
  graphqlEndpoint: '/api/graphql', // GraphQL ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®š
});

export const loader = async ({ request, context }: Route.LoaderArgs) => {
  const response = await yoga.handleRequest(request, context);
  return new Response(response.body, response);
};

export const action = async ({ request, context }: Route.ActionArgs) => {
  const response = await yoga.handleRequest(request, context);
  return new Response(response.body, response);
};
```

Yoga GraphiQL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã€‚  

```sh
npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰`localhost:xxxx/api/graphql`ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é–‹ãã€‚
![image](https://storage.googleapis.com/zenn-user-upload/839312c715e9-20250225.png)

## 3ï¸âƒ£ POTHOS GraphQLã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

GraphQLã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ãƒ¼ã§ã‚ã‚‹ã€POTHOSã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ãã¾ã™ã€‚

### 3.1 ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ¢ãƒ‡ãƒ«ä½œæˆ

prismaã‚¹ã‚­ãƒ¼ãƒã«å„ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```prisma: prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ...

model Planet {
  id        String              @id @default(uuid())
  name      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  clusters  PlanetStarCluster[] // ä¸­é–“ãƒ¢ãƒ‡ãƒ«ã‚’é€šã˜ãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
}

model StarCluster {
  id        String              @id @default(uuid())
  name      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  planets   PlanetStarCluster[] // ä¸­é–“ãƒ¢ãƒ‡ãƒ«ã‚’é€šã˜ãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
}

model PlanetStarCluster {
  planet        Planet      @relation(fields: [planetId], references: [id])
  planetId      String
  starCluster   StarCluster @relation(fields: [starClusterId], references: [id])
  starClusterId String
  assignedAt    DateTime    @default(now()) // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚ŒãŸæ—¥æ™‚

  @@id([planetId, starClusterId]) // è¤‡åˆä¸»ã‚­ãƒ¼
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  image     String?
  provider  String   @default("Credentials")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### 3.2 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm i @pothos/core @pothos/plugin-prisma @pothos/plugin-relay @pothos/plugin-simple-objects @pothos/plugin-scope-auth graphql-scalars
```

:::details å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è§£èª¬

- **@pothos/core**: Pothosã¯ã€GraphQLã‚¹ã‚­ãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚å‹å®‰å…¨ã§æŸ”è»Ÿãªã‚¹ã‚­ãƒ¼ãƒä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

- **@pothos/plugin-prisma**: Prismaã®å‹ã‚’åˆ©ç”¨ã—ã¦ã€å‹å®‰å…¨ãªGraphQLã‚¹ã‚­ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚

- **@pothos/plugin-relay**: Relayè¦ç´„ã«åŸºã¥ã„ãŸãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

- **@pothos/plugin-simple-objects**: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ï¼ˆä¾‹ãˆã°ã€tokenã ã‘ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’ç°¡å˜ã«å®šç¾©ã§ãã¾ã™ã€‚

- **@pothos/plugin-scope-auth**: ã‚¹ã‚³ãƒ¼ãƒ—ã«åŸºã¥ã„ãŸèªè¨¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€GraphQLãƒªã‚¯ã‚¨ã‚¹ãƒˆã«èªè¨¼ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

- **graphql-scalars**: `DateTime`å‹ãªã©ã€æ¨™æº–ã«ã¯ãªã„ã‚¹ã‚«ãƒ©å‹ã‚’åˆ©ç”¨ã§ãã€æ—¥æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‹å®‰å…¨ã«æ‰±ãˆã¾ã™ã€‚
:::

### 3.3 prisma.schemaã«prisma-pothos-typesã®è¨­å®šã‚’è¿½åŠ 

prisma-pothos-types ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```prisma: prisma/schema.prisma
generator pothos {
  provider     = "prisma-pothos-types"
}
```

è¿½åŠ ã—ãŸè¨­å®šã‚’åæ˜ ã™ã‚‹ãŸã‚ã«ã€`prisma generate`ã‚’å®Ÿè¡Œã—ã¦ãŠãã¾ã™ã€‚

```sh
npx prisma generate
```

### 3.4 ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æº–å‚™ã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/context.ts
import type { User } from '@prisma/client';
import type { YogaInitialContext } from 'graphql-yoga';

export interface Context extends YogaInitialContext {
  user?: User;
}
```

ã‚¹ã‚­ãƒ¼ãƒãƒ“ãƒ«ãƒ€ãƒ¼ã‚’æº–å‚™ã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/builder.ts
import SchemaBuilder from '@pothos/core';
import PrismaPlugin from '@pothos/plugin-prisma';
import type PrismaTypes from '@pothos/plugin-prisma/generated';
import RelayPlugin from '@pothos/plugin-relay';
import ScopeAuthPlugin from '@pothos/plugin-scope-auth';
import PothosSimpleObjectsPlugin from '@pothos/plugin-simple-objects';
import { Prisma } from '@prisma/client';
import { DateTimeResolver } from 'graphql-scalars';
import { prisma } from '../prisma-client';
import type { Context } from './context';

export const builder = new SchemaBuilder<{
  Scalars: {
    DateTime: {
      Input: Date;
      Output: Date;
    };
  };
  AuthScopes: {
    loggedIn: boolean;
  };
  Connection: {
    totalCount: number | (() => number | Promise<number>);
  };
  PrismaTypes: PrismaTypes;
  Context: Context;
}>({
  plugins: [
    ScopeAuthPlugin,
    PrismaPlugin,
    RelayPlugin,
    PothosSimpleObjectsPlugin,
  ],
  scopeAuth: {
    authorizeOnSubscribe: true,
    authScopes: async (ctx) => ({
      loggedIn: !!ctx.user,
    }),
  },
  relay: {},
  prisma: {
    client: prisma,
    dmmf: Prisma.dmmf,
  },
});

builder.queryType();
builder.mutationType();

builder.addScalarType('DateTime', DateTimeResolver, {});
```

### 3.5 Planetã‚’å®Ÿè£…

#### Typeã‚’ä½œæˆ

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€Planetã®Typeã‚’ä½œæˆã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/modules/planet/planet.type.ts
import { builder } from '../../builder';

export const definePlanetType = () => {
  builder.prismaNode('Planet', {
    id: { field: 'id' },
    findUnique: (id) => ({ id }),
    fields: (t) => ({
      name: t.exposeString('name'),
      clusters: t.relation('clusters'),
    }),
  });
};
```

#### Dtoã‚’ä½œæˆ

argsã¨inputã«åˆ†ã‘ã¦ä½œæˆã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/modules/planet/dto/args/get-planet-args.dto.ts
import { builder } from '~/.server/lib/graphql/builder';

export const GetPlanetArgs = builder.inputType('GetPlanetArgs', {
  fields: (t) => ({
    id: t.string({ required: true }),
  }),
});
```

```ts: app/.server/lib/graphql/modules/planet/dto/input/create-planet-input.dto.ts
import { builder } from '~/.server/lib/graphql/builder';

export const CreatePlanetInput = builder.inputType('CreatePlanetInput', {
  fields: (t) => ({
    name: t.string({ required: true }),
    starClusterIds: t.stringList({ required: false }),
  }),
});
```

```ts: app/.server/lib/graphql/modules/planet/dto/input/update-planet-input.dto.ts
import { builder } from '~/.server/lib/graphql/builder';

export const UpdatePlanetInput = builder.inputType('UpdatePlanetInput', {
  fields: (t) => ({
    id: t.string({ required: true }),
    name: t.string({ required: true }),
    starClusterIds: t.stringList({ required: false }),
  }),
});
```

```ts: app/.server/lib/graphql/modules/planet/dto/input/delete-planet-input.dto.ts
import { builder } from '~/.server/lib/graphql/builder';

export const DeletePlanetInput = builder.inputType('DeletePlanetInput', {
  fields: (t) => ({
    id: t.string({ required: true }),
  }),
});
```

#### Resolverã‚’ä½œæˆ

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€Planetã®Resolverã‚’ä½œæˆã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/modules/planet/planet.resolver.ts
import { decodeGlobalID } from '@pothos/plugin-relay';
import { prisma } from '~/.server/lib/prisma-client';
import { builder } from '../../builder';
import { GetPlanetArgs } from './dto/args/get-planet-args.dto';
import { CreatePlanetInput } from './dto/input/create-planet-input.dto';
import { DeletePlanetInput } from './dto/input/delete-planet-input.dto';
import { UpdatePlanetInput } from './dto/input/update-planet-input.dto';

export const definePlanetResolver = () => {
  // --- Query
  builder.queryField('planets', (t) =>
    t.prismaConnection({
      type: 'Planet',
      cursor: 'id',
      resolve: (query) => prisma.planet.findMany({ ...query }),
      totalCount: () => prisma.planet.count(),
    }),
  );

  builder.queryField('planet', (t) =>
    t.prismaField({
      type: 'Planet',
      args: { args: t.arg({ type: GetPlanetArgs, required: true }) },
      resolve: async (query, _parent, { args }) => {
        const { id: rawId } = decodeGlobalID(args.id);
        return await prisma.planet.findUnique({
          ...query,
          where: { id: rawId },
        });
      },
    }),
  );

  // --- Mutation
  builder.mutationField('createPlanet', (t) =>
    t.prismaField({
      type: 'Planet',
      nullable: false,
      args: { input: t.arg({ type: CreatePlanetInput, required: true }) },
      resolve: async (query, _parent, { input }, _ctx) => {
        const createdPlanet = await prisma.planet.create({
          ...query,
          data: {
            name: input.name,
          },
        });

        if (input.starClusterIds && input.starClusterIds.length > 0) {
          const starClusterInputs = input.starClusterIds.map(
            (starClusterId) => ({
              planetId: createdPlanet.id,
              starClusterId,
            }),
          );

          await prisma.planetStarCluster.createMany({
            data: starClusterInputs,
          });
        }

        return createdPlanet;
      },
    }),
  );

  builder.mutationField('updatePlanet', (t) =>
    t.prismaField({
      type: 'Planet',
      nullable: true,
      args: { input: t.arg({ type: UpdatePlanetInput, required: true }) },
      resolve: async (query, _parent, { input }, _ctx) => {
        const { id: rawId } = decodeGlobalID(input.id);
        const updatedPlanet = await prisma.planet.update({
          ...query,
          where: {
            id: rawId,
          },
          data: {
            name: input.name,
          },
        });

        if (input.starClusterIds) {
          await prisma.planetStarCluster.deleteMany({
            where: {
              planetId: rawId,
            },
          });

          if (input.starClusterIds.length > 0) {
            const starClusterInputs = input.starClusterIds.map(
              (starClusterId) => ({
                planetId: updatedPlanet.id,
                starClusterId,
              }),
            );

            await prisma.planetStarCluster.createMany({
              data: starClusterInputs,
            });
          }
        }

        return updatedPlanet;
      },
    }),
  );

  builder.mutationField('deletePlanet', (t) =>
    t.prismaField({
      type: 'Planet',
      nullable: true,
      args: { input: t.arg({ type: DeletePlanetInput, required: true }) },
      resolve: async (query, _, { input }) => {
        const { id: rawId } = decodeGlobalID(input.id);
        return await prisma.planet.delete({
          ...query,
          where: { id: rawId },
        });
      },
    }),
  );
};
```

#### Moduleã‚’ä½œæˆ

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€Planetã®Moduleã‚’ä½œæˆã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/modules/planet/planet.module.ts
import { definePlanetResolver } from './planet.resolver';
import { definePlanetType } from './planet.type';

export const setupPlanetModule = () => {
  definePlanetType();
  definePlanetResolver();
  console.log('Planet module has been defined');
};
```

#### schema.tsã«åæ˜ 

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€schema.tsã«åæ˜ ã—ã¾ã™ã€‚

```ts: app/.server/lib/graphql/schema.ts
import { builder } from './builder';
import { setupPlanetModule } from './modules/planet/planet.module';

setupPlanetModule();

export const schema = builder.toSchema();
```
